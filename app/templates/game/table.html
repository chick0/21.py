{% extends 'layout.html' %}
{% block content %}
    <div class="container">
        <div id="game_result"></div>
        <h4><span class="badge bg-secondary">컴퓨터</span> {{ game['you']['name'] }}</h4>
        <p class="lead">합계: <b id="you_total">{{ [ game['you']['hand'][0] ]|calc_total }}</b>/21</p>

        <div id="you_hand">
            <img src="/static/card_img/{{ game['you']['hand'][0] }}.png" alt="{{ game['you']['hand'][0]|get_display_card_name }}">
        {% for i in range(0, game['you']['hand']|length -1) %}
            <img src="/static/card_img/back.png" alt="Hidden Card">
        {% endfor %}
        </div>

        <hr>

        <h4><span class="badge bg-info">나</span> {{ game['me']['name'] }}</h4>
        <p class="lead">합계: <b id="my_total">{{ game['me']['hand']|calc_total }}</b>/21</p>

        <div id="my_hand">
        {% for card in game['me']['hand'] %}
            <img src="/static/card_img/{{card}}.png" alt="{{ card|get_display_card_name }}">
        {% endfor %}
        </div>

        <br>
        <div class="d-grid gap-2">
            <div class="btn-group">
                <button class="btn btn-primary" id="hit">Hit</button>
                <button class="btn btn-danger" id="stand">Stand</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='axios.min.js') }}"></script>
    <script>
        const hit = document.getElementById("hit");
        const stand = document.getElementById("stand");

        function call_stand(){
            axios({
                method: "GET",
                url: "{{ url_for('api.stand', session_id=session_id) }}"
            }).then(function(resp){
                if(resp.data.game == "end"){
                    document.getElementById("you_hand").innerHTML="";
                    resp.data.you.hand.forEach(function(card){
                        var you = document.createElement("img");
                        you.setAttribute("src", card.src);
                        you.setAttribute("alt", card.alt);
                        document.getElementById("you_hand").appendChild(document.createTextNode(" "));
                        document.getElementById("you_hand").appendChild(you);
                    });
                    document.getElementById("you_total").innerText=resp.data.you.total;
                    document.getElementById("game_result").setAttribute("class", resp.data.alert.class);
                    document.getElementById("game_result").innerHTML+=`<h4 class="alert-heading">${resp.data.alert.head}</h4>`;
                    document.getElementById("game_result").innerHTML+=resp.data.alert.body+"<hr>";
                    document.getElementById("game_result").innerHTML+='<p class="mb-0"><a class="btn btn-primary" href="/game/new">새로운 게임</a></p>';
                }
                else if(resp.data.game == "not found"){
                    location.replace("/game/new");
                }
            }).catch(function(err){
                window.alert("오류가 발생했습니다. 버튼을 다시 눌러주십시오.");
            });
        }

        hit.addEventListener("click", function(){
            axios({
                method: "GET",
                url: "{{ url_for('api.hit', session_id=session_id) }}"
            }).then(function(resp){
                if(resp.data.game == "ok"){
                    if(resp.data.new_card.you){
                        var you = document.createElement("img");
                        you.setAttribute("src", "/static/card_img/back.png");
                        you.setAttribute("alt", "Hidden Card");
                        document.getElementById("you_hand").appendChild(document.createTextNode(" "));
                        document.getElementById("you_hand").appendChild(you);
                    }

                    var me = document.createElement("img");
                    me.setAttribute("src", resp.data.new_card.me.src);
                    me.setAttribute("alt", resp.data.new_card.me.alt);
                    document.getElementById("my_hand").appendChild(document.createTextNode(" "));
                    document.getElementById("my_hand").appendChild(me);
                    document.getElementById("my_total").innerText=resp.data.new_card.me.total;
                }
                else if(resp.data.game == "not found"){
                    location.replace("/game/new");
                }
                else if(resp.data.game == "bust"){
                    call_stand();
                }
                else if(resp.data.game == "bust with new card"){
                    var me = document.createElement("img");
                    me.setAttribute("src", resp.data.new_card.me.src);
                    me.setAttribute("alt", resp.data.new_card.me.alt);
                    document.getElementById("my_hand").appendChild(document.createTextNode(" "));
                    document.getElementById("my_hand").appendChild(me);
                    document.getElementById("my_total").innerText=resp.data.new_card.me.total;
                    call_stand();
                }
            }).catch(function(err){
                window.alert("오류가 발생했습니다. 버튼을 다시 눌러주십시오.");
            });
        });
        stand.addEventListener("click", call_stand);
    </script>
{% endblock %}