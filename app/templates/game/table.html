{% extends 'layout.html' %}
{% block content %}
    <div class="container">
        <h4><span class="badge bg-secondary">컴퓨터</span> {{ game['you']['name'] }}</h4>
        <p class="lead">합계: <b id="your_total">{{ [ game['you']['hand'][0] ]|calc_total }}</b>/21</p>

        <div id="your_hand">
            <img src="/static/card_img/{{ game['you']['hand'][0] }}.png" alt="{{ game['you']['hand'][0]|get_display_card_name }}">
        {% for i in range(0, game['you']['hand']|length -1) %}
            <img src="/static/card_img/back.png" alt="Hidden Card">
        {% endfor %}
        </div>

        <hr>

        <h4><span class="badge bg-primary">나</span> {{ game['me']['name'] }}</h4>
        <p class="lead">합계: <b id="my_total">{{ game['me']['hand']|calc_total }}</b>/21</p>

        <div id="my_hand">
        {% for card in game['me']['hand'] %}
            <img src="/static/card_img/{{card}}.png" alt="{{ card|get_display_card_name }}">
        {% endfor %}
        </div>

        <div class="d-grid gap-2 py-3">
            <div class="btn-group">
                <button class="btn btn-primary" id="hit">Hit</button>
                <button class="btn btn-danger" id="stand">Stand</button>
            </div>
        </div>

        <div class="py-5">
            <p class="lead mb-0">승률 <b id="winning_rate_text">{{ game['count']['winning_rate'] }}%</b></p>
            <div class="progress">
                <div class="{{ g.dark | dk_progress }}" role="progressbar" id="winning_rate" style="width:{{game['count']['winning_rate']}}%"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="showWinStatus" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered ">
            <div class="modal-content {{ g.dark | dk_body }}">
                <div class="modal-header" style="border:0;">
                    <h5 class="modal-title" id="statusHead"></h5>
                </div>
                <div class="modal-body" id="statusBody"></div>
                <div class="modal-footer" style="border:0;">
                    <button type="button" id="reset" data-bs-dismiss="modal">다시하기</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script src="{{ url_for('static', filename='axios.min.js') }}"></script>
    <script>
        const hit = document.getElementById("hit");
        const stand = document.getElementById("stand");
        const reset = document.getElementById("reset");

        function call_stand(){
            axios({
                method: "GET",
                url: "{{ url_for('api.stand') }}"
            }).then(function(resp){
                if(resp.data.game == "end"){
                    document.getElementById("your_hand").innerHTML="";
                    document.getElementById("winning_rate").setAttribute("style",`width:${resp.data.count.winning_rate}%;`);
                    document.getElementById("winning_rate_text").innerText=resp.data.count.winning_rate+"%";
                    resp.data.you.hand.forEach(function(card){
                        var you = document.createElement("img");
                        you.setAttribute("src", card.src);
                        you.setAttribute("alt", card.alt);
                        document.getElementById("your_hand").appendChild(document.createTextNode(" "));
                        document.getElementById("your_hand").appendChild(you);
                    });
                    document.getElementById("your_total").innerText=resp.data.you.total;
                    document.getElementById("reset").setAttribute("class", `btn btn-${resp.data.alert.color}`);
                    document.getElementById("statusHead").setAttribute("class", `modal-title text-${resp.data.alert.color}`);
                    document.getElementById("statusHead").innerText=resp.data.alert.head;
                    document.getElementById("statusBody").innerHTML=resp.data.alert.body;
                    new bootstrap.Modal(document.getElementById("showWinStatus")).show();
                }
                else if(resp.data.game == "not found"){
                    location.replace("{{ url_for('game.table') }}");
                }
            }).catch(function(err){
                window.alert("오류가 발생했습니다. 버튼을 다시 눌러주십시오.");
            });
        }

        hit.addEventListener("click", function(){
            axios({
                method: "GET",
                url: "{{ url_for('api.hit') }}"
            }).then(function(resp){
                if(resp.data.game == "ok"){
                    if(resp.data.you){
                        var you = document.createElement("img");
                        you.setAttribute("src", "/static/card_img/back.png");
                        you.setAttribute("alt", "Hidden Card");
                        document.getElementById("your_hand").appendChild(document.createTextNode(" "));
                        document.getElementById("your_hand").appendChild(you);
                    }

                    var me = document.createElement("img");
                    me.setAttribute("src", resp.data.me.src);
                    me.setAttribute("alt", resp.data.me.alt);
                    document.getElementById("my_hand").appendChild(document.createTextNode(" "));
                    document.getElementById("my_hand").appendChild(me);
                    document.getElementById("my_total").innerText=resp.data.me.total;
                }
                else if(resp.data.game == "not found"){
                    location.replace("{{ url_for('game.table') }}");
                }
                else if(resp.data.game == "bust"){
                    call_stand();
                }
                else if(resp.data.game == "bust with new card"){
                    var me = document.createElement("img");
                    me.setAttribute("src", resp.data.me.src);
                    me.setAttribute("alt", resp.data.me.alt);
                    document.getElementById("my_hand").appendChild(document.createTextNode(" "));
                    document.getElementById("my_hand").appendChild(me);
                    document.getElementById("my_total").innerText=resp.data.me.total;
                    call_stand();
                }
            }).catch(function(err){
                window.alert("오류가 발생했습니다. 버튼을 다시 눌러주십시오.");
            });
        });
        stand.addEventListener("click", call_stand);
        reset.addEventListener("click", function(){
            axios({
                method: "GET",
                url: "{{ url_for('api.status') }}"
            }).then(function(resp){
                document.getElementById("your_total").innerText=resp.data.you.total;
                document.getElementById("my_total").innerText=resp.data.me.total;
                document.getElementById("your_hand").innerHTML="";
                document.getElementById("my_hand").innerHTML="";
                resp.data.you.hand.forEach(function(card){
                    var you = document.createElement("img");
                    you.setAttribute("src", card.src);
                    you.setAttribute("alt", card.alt);
                    document.getElementById("your_hand").appendChild(document.createTextNode(" "));
                    document.getElementById("your_hand").appendChild(you);
                });
                resp.data.me.hand.forEach(function(card){
                    var me = document.createElement("img");
                    me.setAttribute("src", card.src);
                    me.setAttribute("alt", card.alt);
                    document.getElementById("my_hand").appendChild(document.createTextNode(" "));
                    document.getElementById("my_hand").appendChild(me);
                });
            }).catch(function(err){
                location.replace("{{ url_for('game.table') }}");
            });
        });
    </script>
{% endblock %}