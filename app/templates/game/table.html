{% extends 'layout.html' %}
{% block content %}
    <div class="container">
        <div id="game_result" style="display:none;">
            <h4 class="alert-heading" id="game_result_head"></h4>
            <span id="game_result_body"></span>
            <hr>
            <p class="mb-0"><button id="reset">다시하기</button></p>
        </div>

        <h4><span class="badge bg-secondary">컴퓨터</span> {{ game['you']['name'] }}</h4>
        <p class="lead">합계: <b id="your_total">{{ [ game['you']['hand'][0] ]|calc_total }}</b>/21</p>

        <div id="your_hand">
            <img src="/static/card_img/{{ game['you']['hand'][0] }}.png" alt="{{ game['you']['hand'][0]|get_display_card_name }}">
        {% for i in range(0, game['you']['hand']|length -1) %}
            <img src="/static/card_img/back.png" alt="Hidden Card">
        {% endfor %}
        </div>

        <hr>

        <h4><span class="badge bg-info">나</span> {{ game['me']['name'] }}</h4>
        <p class="lead">합계: <b id="my_total">{{ game['me']['hand']|calc_total }}</b>/21</p>

        <div id="my_hand">
        {% for card in game['me']['hand'] %}
            <img src="/static/card_img/{{card}}.png" alt="{{ card|get_display_card_name }}">
        {% endfor %}
        </div>

        <div class="d-grid gap-2 py-3">
            <div class="btn-group" id="gm_btn_div_box" style="display:inline-flex;">
                <button class="btn btn-primary" id="hit">Hit</button>
                <button class="btn btn-danger" id="stand">Stand</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='axios.min.js') }}"></script>
    <script>
        const hit = document.getElementById("hit");
        const stand = document.getElementById("stand");
        const reset = document.getElementById("reset");

        function call_stand(){
            axios({
                method: "GET",
                url: "{{ url_for('api.stand') }}"
            }).then(function(resp){
                if(resp.data.game == "end"){
                    document.getElementById("your_hand").innerHTML="";
                    resp.data.you.hand.forEach(function(card){
                        var you = document.createElement("img");
                        you.setAttribute("src", card.src);
                        you.setAttribute("alt", card.alt);
                        document.getElementById("your_hand").appendChild(document.createTextNode(" "));
                        document.getElementById("your_hand").appendChild(you);
                    });
                    document.getElementById("your_total").innerText=resp.data.you.total;
                    document.getElementById("reset").setAttribute("class", `btn btn-${resp.data.alert.color}`);
                    document.getElementById("game_result").setAttribute("class", `alert alert-${resp.data.alert.color}`);
                    document.getElementById("game_result_head").innerText=resp.data.alert.head;
                    document.getElementById("game_result_body").innerHTML=resp.data.alert.body;
                    document.getElementById("gm_btn_div_box").setAttribute("style", "display:none");
                    document.getElementById("game_result").setAttribute("style", "display:block;");
                    document.getElementById("reset").focus();
                }
                else if(resp.data.game == "not found"){
                    location.replace("{{ url_for('game.table') }}");
                }
            }).catch(function(err){
                window.alert("오류가 발생했습니다. 버튼을 다시 눌러주십시오.");
            });
        }

        hit.addEventListener("click", function(){
            axios({
                method: "GET",
                url: "{{ url_for('api.hit') }}"
            }).then(function(resp){
                if(resp.data.game == "ok"){
                    if(resp.data.you){
                        var you = document.createElement("img");
                        you.setAttribute("src", "/static/card_img/back.png");
                        you.setAttribute("alt", "Hidden Card");
                        document.getElementById("your_hand").appendChild(document.createTextNode(" "));
                        document.getElementById("your_hand").appendChild(you);
                    }

                    var me = document.createElement("img");
                    me.setAttribute("src", resp.data.me.src);
                    me.setAttribute("alt", resp.data.me.alt);
                    document.getElementById("my_hand").appendChild(document.createTextNode(" "));
                    document.getElementById("my_hand").appendChild(me);
                    document.getElementById("my_total").innerText=resp.data.me.total;
                }
                else if(resp.data.game == "not found"){
                    location.replace("{{ url_for('game.table') }}");
                }
                else if(resp.data.game == "bust"){
                    call_stand();
                }
                else if(resp.data.game == "bust with new card"){
                    var me = document.createElement("img");
                    me.setAttribute("src", resp.data.me.src);
                    me.setAttribute("alt", resp.data.me.alt);
                    document.getElementById("my_hand").appendChild(document.createTextNode(" "));
                    document.getElementById("my_hand").appendChild(me);
                    document.getElementById("my_total").innerText=resp.data.me.total;
                    call_stand();
                }
            }).catch(function(err){
                window.alert("오류가 발생했습니다. 버튼을 다시 눌러주십시오.");
            });
        });
        stand.addEventListener("click", call_stand);
        reset.addEventListener("click", function(){
            axios({
                method: "GET",
                url: "{{ url_for('api.status') }}"
            }).then(function(resp){
                document.getElementById("your_total").innerText=resp.data.you.total;
                document.getElementById("my_total").innerText=resp.data.me.total;
                document.getElementById("your_hand").innerHTML="";
                document.getElementById("my_hand").innerHTML="";
                resp.data.you.hand.forEach(function(card){
                    var you = document.createElement("img");
                    you.setAttribute("src", card.src);
                    you.setAttribute("alt", card.alt);
                    document.getElementById("your_hand").appendChild(document.createTextNode(" "));
                    document.getElementById("your_hand").appendChild(you);
                });
                resp.data.me.hand.forEach(function(card){
                    var me = document.createElement("img");
                    me.setAttribute("src", card.src);
                    me.setAttribute("alt", card.alt);
                    document.getElementById("my_hand").appendChild(document.createTextNode(" "));
                    document.getElementById("my_hand").appendChild(me);
                });
                document.getElementById("gm_btn_div_box").setAttribute("style", "display:inline-flex");
                document.getElementById("game_result").setAttribute("style", "display:none;");
            }).catch(function(err){
                location.replace("{{ url_for('game.table') }}");
            });
        });
    </script>
{% endblock %}